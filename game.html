<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ava's Games">
  <meta name="theme-color" content="#6c5ce7">
  <title>Game - Ava's Learning Games</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/game.css">
  <link rel="stylesheet" href="css/breakfast-helper.css">
  <link rel="stylesheet" href="css/santa-delivery.css">
  <link rel="stylesheet" href="css/cobbler-game.css">
</head>
<body>
  <div class="game-page" id="game-page">
    <!-- HUD bar: back button + lives/progress inserted by game-base.js -->
    <div id="game-hud-container">
      <button class="back-btn" id="back-btn" aria-label="Back to games">&larr;</button>
    </div>

    <!-- Game scene (populated by game JS) -->
    <div class="game-scene" id="game-scene"></div>

    <!-- Input area inserted by game-base.js -->
    <div id="game-input-container"></div>
  </div>

  <!-- Core engines -->
  <script src="js/math-engine.js"></script>
  <script src="js/spelling-engine.js"></script>
  <script src="js/audio-manager.js"></script>
  <script src="js/word-audio-manager.js"></script>
  <script src="js/game-base.js"></script>
  <script src="js/spelling-game-base.js"></script>

  <!-- Game modules -->
  <script src="js/games/animal-crossing.js"></script>
  <script src="js/games/breakfast-helper.js"></script>

  <script>
    // Games that require Phaser 3
    var PHASER_GAMES = ['santa-delivery', 'cobbler'];

    // Parse URL params and launch the right game
    (function() {
      var params = new URLSearchParams(window.location.search);
      var gameId = params.get('game') || 'animal-crossing';
      var mode = params.get('mode') || 'type';
      var count = parseInt(params.get('count'), 10) || 10;
      var subject = params.get('subject') || 'math';
      var difficulty = params.get('difficulty') || 'easy';
      var presentation = params.get('presentation') || 'audio-picture';
      var timedParam = params.get('timed');
      var timed = timedParam !== 'false'; // default true

      // Select engine based on subject
      var gameEngine = MathEngine; // default
      if (subject === 'spelling' && typeof SpellingEngine !== 'undefined') {
        gameEngine = SpellingEngine;
      }

      // Audio unlock on first touch
      var unlockHandler = function() {
        AudioManager.unlock();
        document.removeEventListener('touchstart', unlockHandler);
        document.removeEventListener('click', unlockHandler);
      };
      document.addEventListener('touchstart', unlockHandler, { once: true });
      document.addEventListener('click', unlockHandler, { once: true });

      // Back button - navigate to subject page
      document.getElementById('back-btn').addEventListener('click', function() {
        window.location.href = subject === 'spelling' ? 'spelling.html' : 'math.html';
      });

      // Check if this game needs Phaser
      var needsPhaser = PHASER_GAMES.indexOf(gameId) !== -1;

      if (needsPhaser) {
        // Dynamically load Phaser CDN, then the scene + game module
        var gameScripts = {
          'santa-delivery': ['js/games/santa-scene.js', 'js/games/santa-delivery.js'],
          'cobbler': ['js/games/cobbler-scene.js', 'js/games/cobbler-game.js'],
        };
        var scripts = gameScripts[gameId] || [];
        loadScript('https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js', function() {
          loadScriptsSequential(scripts, 0, function() {
            launchGame(gameId, mode, count, gameEngine, difficulty, presentation);
          });
        });
      } else {
        launchGame(gameId, mode, count, gameEngine, difficulty, presentation);
      }

      function launchGame(id, mode, count, engine, difficulty, presentation) {
        var gameOptions = { mode: mode, questionCount: count, engine: engine };

        if (id === 'animal-crossing') {
          AnimalCrossing.start(gameOptions);
        } else if (id === 'breakfast-helper') {
          BreakfastHelper.start(gameOptions);
        } else if (id === 'santa-delivery') {
          SantaDelivery.start({
            mode: difficulty === 'hard' ? 'keyboard' : 'scramble',
            questionCount: count,
            difficulty: difficulty,
            presentation: presentation,
          });
        } else if (id === 'cobbler') {
          CobblersWorkshop.start({
            mode: difficulty === 'hard' ? 'keyboard' : 'scramble',
            questionCount: count,
            difficulty: difficulty,
            presentation: presentation,
            timed: timed,
          });
        }
      }

      function loadScriptsSequential(srcs, idx, callback) {
        if (idx >= srcs.length) { callback(); return; }
        loadScript(srcs[idx], function() {
          loadScriptsSequential(srcs, idx + 1, callback);
        });
      }

      function loadScript(src, callback) {
        var script = document.createElement('script');
        script.src = src;
        script.onload = callback;
        script.onerror = function() {
          console.error('Failed to load script: ' + src);
          var sceneEl = document.getElementById('game-scene');
          if (sceneEl) {
            sceneEl.textContent = '';
            var errDiv = document.createElement('div');
            errDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%;text-align:center;padding:20px;color:#636e72;';
            errDiv.textContent = 'Could not load game. Please check your connection and try again.';
            sceneEl.appendChild(errDiv);
          }
        };
        document.head.appendChild(script);
      }
    })();
  </script>
</body>
</html>
